<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario Autoevaluación IPS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #1e5a7d;
            --secondary-color: #2c8a9e;
            --accent-color: #4bb543;
            --danger-color: #dc3545;
            --light-bg: #f8f9fa;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: var(--card-shadow);
        }

        .header h1 {
            font-weight: 700;
        }

        .header p {
            opacity: 0.9;
        }

        .card {
            border: none;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 1rem 1.5rem;
            font-weight: 600;
        }

        .form-section {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }

        .form-control,
        .form-select {
            border-radius: 8px;
            padding: 0.75rem 1rem;
            border: 1px solid #ddd;
            transition: all 0.3s;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(30, 90, 125, 0.25);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 8px;
        }

        .btn-primary:hover {
            background-color: #16425c;
            border-color: #16425c;
        }

        .btn-success {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 8px;
        }

        .btn-success:hover {
            background-color: #3a9a33;
            border-color: #3a9a33;
        }

        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 8px;
        }

        .btn-danger:hover {
            background-color: #bb2d3b;
            border-color: #bb2d3b;
        }

        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 8px;
        }

        .btn-secondary:hover {
            background-color: #5c636a;
            border-color: #5c636a;
        }

        .result-card {
            background-color: white;
            border-left: 5px solid var(--primary-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--card-shadow);
        }

        .result-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .category-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-color);
        }

        .service-table {
            width: 100%;
            margin-bottom: 1.5rem;
        }

        .service-table th {
            background-color: var(--light-bg);
            font-weight: 600;
            padding: 1rem;
        }

        .service-table td {
            padding: 1rem;
            vertical-align: top;
        }

        .service-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .service-table select {
            width: 100%;
            padding: 0.5rem;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .service-description {
            font-size: 0.9rem;
            color: #666;
        }

        .service-description li {
            margin-bottom: 0.5rem;
        }

        .average-score {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 2rem;
            margin-bottom: 3rem;
        }

        .service-title {
            color: var(--primary-color);
            font-weight: 600;
            margin-top: 2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--light-bg);
        }

        @media (max-width: 768px) {
            .action-buttons {
                flex-direction: column;
            }

            .action-buttons .btn {
                width: 100%;
            }
        }

        .floating-home-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 100;
            transition: all 0.3s;
        }

        .floating-home-btn:hover {
            transform: scale(1.1);
            color: white;
        }

        .factor-icon {
            font-size: 1.5rem;
            margin-right: 10px;
            color: var(--primary-color);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <!-- Agregar esto en el head -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <header class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-hospital me-2"></i>Autoevaluación de Establecimientos de Salud</h1>
                    <p class="mb-0">Complete este formulario para evaluar los servicios de su institución de salud</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <a href="index.html"><img src="https://via.placeholder.com/100x60?text=LOGO" alt="Logo"
                            class="img-fluid" style="max-height: 60px;"></a>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <div class="form-section">
                    <h2 class="mb-4"><i class="fas fa-hospital-user me-2"></i>Identificación del Establecimiento</h2>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="establishmentName" class="form-label">Nombre del Establecimiento</label>
                            <input type="text" class="form-control" id="establishmentName">
                        </div>
                        <div class="col-md-6">
                            <label for="department" class="form-label">Departamento y Distrito</label>
                            <input type="text" class="form-control" id="department">
                        </div>
                        <div class="col-md-6">
                            <label for="establishmentID" class="form-label">Código o ID del Establecimiento</label>
                            <input type="text" class="form-control" id="establishmentID">
                        </div>
                        <div class="col-md-6">
                            <label for="evaluationDate" class="form-label">Fecha de evaluación</label>
                            <input type="date" class="form-control" id="evaluationDate">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h2 class="mb-4"><i class="fas fa-user-md me-2"></i>Datos del Evaluador</h2>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="evaluatorName" class="form-label">Nombre completo</label>
                            <input type="text" class="form-control" id="evaluatorName">
                        </div>
                        <div class="col-md-6">
                            <label for="evaluatorRole" class="form-label">Cargo o función</label>
                            <input type="text" class="form-control" id="evaluatorRole">
                        </div>
                        <div class="col-md-6">
                            <label for="evaluatorPhone" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="evaluatorPhone">
                        </div>
                        <div class="col-md-6">
                            <label for="evaluatorEmail" class="form-label">Correo electrónico</label>
                            <input type="email" class="form-control" id="evaluatorEmail">
                        </div>
                    </div>
                </div>

                <!-- Sección de Servicios -->
                <h2 class="service-title"><i class="fas fa-clipboard-list me-2"></i>Evaluación de Servicios</h2>

                <div class="service-section">
                    <h3 class="service-title">A.1 - Consultorio Externo</h3>
                    <table class="service-table">
                        <thead>
                            <tr>
                                <th>Dimensión</th>
                                <th style="width: 200px;">Puntaje</th>
                                <th>Descripción de Niveles</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Recursos Humanos</td>
                                <td>
                                    <select class="form-select servicio" data-servicio="a1">
                                        <option value="">Seleccionar</option>
                                        <option value="1">A - Atención básica / Recurso mínimo</option>
                                        <option value="2">B - Con equipamiento parcial o formación básica</option>
                                        <option value="3">C - Estándar institucional / Médico general</option>
                                        <option value="4">D - Atención especializada / Recursos avanzados</option>
                                        <option value="5">E - Subespecializado / Alta complejidad</option>
                                    </select>
                                </td>
                                <td>
                                    <ul class="service-description">
                                        <li>A - Atención básica / Recurso mínimo</li>
                                        <li>B - Con equipamiento parcial o formación básica</li>
                                        <li>C - Estándar institucional / Médico general</li>
                                        <li>D - Atención especializada / Recursos avanzados</li>
                                        <li>E - Subespecializado / Alta complejidad</li>
                                    </ul>
                                </td>
                            </tr>
                            <tr>
                                <td>Recursos Tecnológicos</td>
                                <td>
                                    <select class="form-select servicio" data-servicio="a1">
                                        <option value="">Seleccionar</option>
                                        <option value="1">A - Atención básica / Recurso mínimo</option>
                                        <option value="2">B - Con equipamiento parcial o formación básica</option>
                                        <option value="3">C - Estándar institucional / Médico general</option>
                                        <option value="4">D - Atención especializada / Recursos avanzados</option>
                                        <option value="5">E - Subespecializado / Alta complejidad</option>
                                    </select>
                                </td>
                                <td>
                                    <ul class="service-description">
                                        <li>A - Atención básica / Recurso mínimo</li>
                                        <li>B - Con equipamiento parcial o formación básica</li>
                                        <li>C - Estándar institucional / Médico general</li>
                                        <li>D - Atención especializada / Recursos avanzados</li>
                                        <li>E - Subespecializado / Alta complejidad</li>
                                    </ul>
                                </td>
                            </tr>
                            <tr>
                                <td>Capacidad Resolutiva</td>
                                <td>
                                    <select class="form-select servicio" data-servicio="a1">
                                        <option value="">Seleccionar</option>
                                        <option value="1">A - Atención básica / Recurso mínimo</option>
                                        <option value="2">B - Con equipamiento parcial o formación básica</option>
                                        <option value="3">C - Estándar institucional / Médico general</option>
                                        <option value="4">D - Atención especializada / Recursos avanzados</option>
                                        <option value="5">E - Subespecializado / Alta complejidad</option>
                                    </select>
                                </td>
                                <td>
                                    <ul class="service-description">
                                        <li>A - Atención básica / Recurso mínimo</li>
                                        <li>B - Con equipamiento parcial o formación básica</li>
                                        <li>C - Estándar institucional / Médico general</li>
                                        <li>D - Atención especializada / Recursos avanzados</li>
                                        <li>E - Subespecializado / Alta complejidad</li>
                                    </ul>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <p class="average-score">Puntaje promedio: <span id="promedio-a1">-</span></p>
                </div>

                <!-- Más servicios aquí (A.2 a C.5) -->
                <!-- Por brevedad, he incluido solo el primer servicio, pero deberías replicar el patrón para todos los servicios -->

                <div class="service-section">
                    <h3 class="service-title">A.2 - Atención de Urgencias</h3>
                    <table class="service-table">
                        <thead>
                            <tr>
                                <th>Dimensión</th>
                                <th style="width: 200px;">Puntaje</th>
                                <th>Descripción de Niveles</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Recursos Humanos</td>
                                <td>
                                    <select class="form-select servicio" data-servicio="a2">
                                        <option value="">Seleccionar</option>
                                        <option value="1">A - Atención básica / Recurso mínimo</option>
                                        <option value="2">B - Con equipamiento parcial o formación básica</option>
                                        <option value="3">C - Estándar institucional / Médico general</option>
                                        <option value="4">D - Atención especializada / Recursos avanzados</option>
                                    </select>
                                </td>
                                <td>
                                    <ul class="service-description">
                                        <li>A - Atención básica / Recurso mínimo</li>
                                        <li>B - Con equipamiento parcial o formación básica</li>
                                        <li>C - Estándar institucional / Médico general</li>
                                        <li>D - Atención especializada / Recursos avanzados</li>
                                    </ul>
                                </td>
                            </tr>
                            <tr>
                                <td>Recursos Tecnológicos</td>
                                <td>
                                    <select class="form-select servicio" data-servicio="a2">
                                        <option value="">Seleccionar</option>
                                        <option value="1">A - Atención básica / Recurso mínimo</option>
                                        <option value="2">B - Con equipamiento parcial o formación básica</option>
                                        <option value="3">C - Estándar institucional / Médico general</option>
                                        <option value="4">D - Atención especializada / Recursos avanzados</option>
                                    </select>
                                </td>
                                <td>
                                    <ul class="service-description">
                                        <li>A - Atención básica / Recurso mínimo</li>
                                        <li>B - Con equipamiento parcial o formación básica</li>
                                        <li>C - Estándar institucional / Médico general</li>
                                        <li>D - Atención especializada / Recursos avanzados</li>
                                    </ul>
                                </td>
                            </tr>
                            <tr>
                                <td>Capacidad Resolutiva</td>
                                <td>
                                    <select class="form-select servicio" data-servicio="a2">
                                        <option value="">Seleccionar</option>
                                        <option value="1">A - Atención básica / Recurso mínimo</option>
                                        <option value="2">B - Con equipamiento parcial o formación básica</option>
                                        <option value="3">C - Estándar institucional / Médico general</option>
                                        <option value="4">D - Atención especializada / Recursos avanzados</option>
                                    </select>
                                </td>
                                <td>
                                    <ul class="service-description">
                                        <li>A - Atención básica / Recurso mínimo</li>
                                        <li>B - Con equipamiento parcial o formación básica</li>
                                        <li>C - Estándar institucional / Médico general</li>
                                        <li>D - Atención especializada / Recursos avanzados</li>
                                    </ul>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <p class="average-score">Puntaje promedio: <span id="promedio-a2">-</span></p>
                </div>

                <!-- Resultados Globales -->
                <div class="result-card">
                    <h3><i class="fas fa-chart-bar me-2"></i>Resultado Global</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <p>Puntaje total:</p>
                            <p class="result-value" id="puntaje-total">-</p>
                        </div>
                        <div class="col-md-6">
                            <p>Categoría asignada:</p>
                            <p class="category-value" id="categoria-final">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-info-circle me-2"></i>Instrucciones
                    </div>
                    <div class="card-body">
                        <p>Complete todos los campos del formulario para evaluar su institución de salud.</p>
                        <p>Para cada servicio, seleccione el nivel que mejor describa su capacidad en cada dimensión.
                        </p>
                        <p>El sistema calculará automáticamente los promedios y la categorización final.</p>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-history me-2"></i>Progreso
                    </div>
                    <div class="card-body">
                        <div class="progress mb-3">
                            <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <p id="progress-text">0% completado</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-question-circle me-2"></i>Ayuda
                    </div>
                    <div class="card-body">
                        <p>Si necesita ayuda con algún campo, consulte las descripciones de niveles en cada sección.</p>
                        <p>Para más información, contacte al soporte técnico:</p>
                        <ul>
                            <li>Email: soporte@salud.gov</li>
                            <li>Teléfono: 0800-555-HELP</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones de acción -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="guardarTemporal()">
                <i class="fas fa-save me-2"></i>Guardar temporalmente
            </button>
            <button class="btn btn-success" onclick="enviarFormulario()">
                <i class="fas fa-paper-plane me-2"></i>Enviar evaluación
            </button>
            <button class="btn btn-secondary" onclick="generarReporte()">
                <i class="fas fa-file-alt me-2"></i>Generar reporte
            </button>
            <button class="btn btn-secondary" onclick="exportarPDF()"> <!-- Cambiado de generarPDF() a exportarPDF() -->
                <i class="fas fa-file-pdf me-2"></i>Exportar a PDF
            </button>
            <button class="btn btn-secondary" onclick="exportarSQLite()">
                <i class="fas fa-database me-2"></i>Exportar a SQLite
            </button>
            <button class="btn btn-danger" onclick="resetearFormulario()">
                <i class="fas fa-trash-alt me-2"></i>Resetear formulario
            </button>
        </div>
    </div>

    <footer class="bg-light py-4 mt-5">
        <div class="container text-center">
            <p class="mb-0">© 2023 Ministerio de Salud Pública. Todos los derechos reservados.</p>
        </div>
    </footer>

    <!-- Botón flotante para volver al index -->
    <a href="index.html" class="floating-home-btn">
        <i class="fas fa-home"></i>
    </a>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
    <script>
        // Variables globales
        const servicios = {};
        const { jsPDF } = window.jspdf; // Inicialización de jsPDF

        // Función para calcular promedios por servicio
        function configurarEventosServicios() {
            document.querySelectorAll('.servicio').forEach(select => {
                select.addEventListener('change', function () {
                    const idServicio = this.dataset.servicio;
                    if (!idServicio) return;

                    const selectsServicio = document.querySelectorAll(`select[data-servicio="${idServicio}"]`);

                    let suma = 0;
                    let contador = 0;

                    selectsServicio.forEach(select => {
                        const valor = parseInt(select.value);
                        if (!isNaN(valor)) {
                            suma += valor;
                            contador++;
                        }
                    });

                    const promedio = contador > 0 ? (suma / contador).toFixed(2) : "-";
                    const promedioElement = document.getElementById(`promedio-${idServicio}`);

                    if (promedioElement) {
                        promedioElement.textContent = promedio;
                        servicios[idServicio] = promedio;

                        actualizarTotales();
                        actualizarProgreso();
                    }
                });
            });
        }

        // Actualizar totales y categoría
        function actualizarTotales() {
            let total = 0;
            let contadorServicios = 0;

            for (const id in servicios) {
                if (servicios.hasOwnProperty(id)) {
                    const valor = parseFloat(servicios[id]);
                    if (!isNaN(valor)) {
                        total += valor;
                        contadorServicios++;
                    }
                }
            }

            const puntajeElement = document.getElementById('puntaje-total');
            const categoriaElement = document.getElementById('categoria-final');

            if (puntajeElement) {
                puntajeElement.textContent = Math.round(total);
            }

            if (categoriaElement) {
                let categoria = "No Categorizado";

                if (total >= 85) categoria = "III - Hospital Especializado / Instituto Nacional";
                else if (total >= 61) categoria = "III - Hospital General Nacional";
                else if (total >= 41) categoria = "II - Hospital Regional";
                else if (total >= 15) categoria = "II - Hospital Básico";
                else if (total >= 9) categoria = "I - USF Estándar o Ampliada";
                else if (total >= 5) categoria = "I - USF Móvil";
                else if (total >= 1) categoria = "I - USF Satélite";

                categoriaElement.textContent = categoria;
            }
        }

        // Actualizar barra de progreso
        function actualizarProgreso() {
            const campos = document.querySelectorAll('input, select');
            const totalCampos = campos.length;
            let completados = 0;

            campos.forEach(campo => {
                if (campo.value && campo.value !== "") completados++;
            });

            const porcentaje = totalCampos > 0 ? Math.round((completados / totalCampos) * 100) : 0;

            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');

            if (progressBar) {
                progressBar.style.width = `${porcentaje}%`;
                progressBar.setAttribute('aria-valuenow', porcentaje);
            }

            if (progressText) {
                progressText.textContent = `${porcentaje}% completado`;
            }
        }

        // Mostrar notificación
        function mostrarNotificacion(mensaje, esError = false) {
            try {
                // Eliminar notificaciones anteriores
                const notificacionesAnteriores = document.querySelectorAll('.custom-notification');
                notificacionesAnteriores.forEach(notif => notif.remove());

                const notificacion = document.createElement('div');
                notificacion.className = 'custom-notification';
                notificacion.style.position = 'fixed';
                notificacion.style.bottom = '20px';
                notificacion.style.right = '20px';
                notificacion.style.backgroundColor = esError ? '#dc3545' : '#28a745';
                notificacion.style.color = 'white';
                notificacion.style.padding = '15px 25px';
                notificacion.style.borderRadius = '8px';
                notificacion.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                notificacion.style.zIndex = '1000';
                notificacion.style.opacity = '0';
                notificacion.style.transition = 'opacity 0.3s ease-in-out';
                notificacion.innerHTML = `<i class="fas ${esError ? 'fa-exclamation-circle' : 'fa-check-circle'} me-2"></i> ${mensaje}`;

                document.body.appendChild(notificacion);

                // Forzar reflow para que la transición funcione
                notificacion.offsetHeight;
                notificacion.style.opacity = '1';

                setTimeout(() => {
                    notificacion.style.opacity = '0';
                    setTimeout(() => {
                        if (notificacion.parentNode) {
                            notificacion.parentNode.removeChild(notificacion);
                        }
                    }, 500);
                }, 3000);
            } catch (error) {
                console.error("Error al mostrar notificación:", error);
            }
        }

        // Guardar temporalmente
        function guardarTemporal() {
            try {
                let contador = 0;
                document.querySelectorAll('input, select').forEach(elemento => {
                    if (elemento.id) {
                        localStorage.setItem(elemento.id, elemento.value);
                        contador++;
                    }
                });

                if (contador > 0) {
                    mostrarNotificacion(`Datos guardados temporalmente (${contador} campos)`);
                } else {
                    mostrarNotificacion('No se encontraron campos para guardar', true);
                }
            } catch (error) {
                console.error("Error al guardar datos:", error);
                mostrarNotificacion('Error al guardar los datos', true);
            }
        }

        // Enviar formulario a WhatsApp como PDF
        function enviarFormulario() {
            const camposRequeridos = [
                'establishmentName',
                'department',
                'establishmentID',
                'evaluatorName',
                'evaluatorRole'
            ];

            let camposFaltantes = [];

            camposRequeridos.forEach(id => {
                const campo = document.getElementById(id);
                if (campo) {
                    if (!campo.value) {
                        campo.classList.add('is-invalid');
                        camposFaltantes.push(id);
                    } else {
                        campo.classList.remove('is-invalid');
                    }
                }
            });

            if (camposFaltantes.length > 0) {
                mostrarNotificacion(`Complete los campos requeridos (${camposFaltantes.length})`, true);
                return;
            }

            try {
                // Mostrar notificación de procesamiento
                mostrarNotificacion("Generando PDF para enviar por WhatsApp...");

                // Crear PDF
                const doc = new jsPDF();

                // Configuración inicial del PDF
                doc.setFont('helvetica');
                doc.setFontSize(16);
                doc.setTextColor(30, 90, 125);
                doc.text('Reporte de Autoevaluación', 105, 20, { align: 'center' });

                // Datos del establecimiento
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);

                const getValue = (id) => {
                    const element = document.getElementById(id);
                    return element ? (element.value || 'No especificado') : 'No disponible';
                };

                doc.text(`Nombre del Establecimiento: ${getValue('establishmentName')}`, 20, 40);
                doc.text(`Ubicación: ${getValue('department')}`, 20, 50);
                doc.text(`ID: ${getValue('establishmentID')}`, 20, 60);
                doc.text(`Evaluador: ${getValue('evaluatorName')} (${getValue('evaluatorRole')})`, 20, 70);

                // Resultados por servicio
                doc.setFontSize(14);
                doc.setTextColor(30, 90, 125);
                doc.text('Resultados por Servicio', 20, 90);

                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);

                let yPos = 100;
                for (const id in servicios) {
                    if (servicios.hasOwnProperty(id)) {
                        doc.text(`${id.toUpperCase()}: ${servicios[id]}`, 20, yPos);
                        yPos += 10;

                        if (yPos > 280) {
                            doc.addPage();
                            yPos = 20;
                        }
                    }
                }

                // Resultado global
                doc.setFontSize(14);
                doc.setTextColor(30, 90, 125);
                doc.text('Resultado Global', 20, yPos + 10);

                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);

                const puntajeElement = document.getElementById('puntaje-total');
                const categoriaElement = document.getElementById('categoria-final');
                const puntaje = puntajeElement ? puntajeElement.textContent : '-';
                const categoria = categoriaElement ? categoriaElement.textContent : 'No categorizado';

                doc.text(`Puntaje total: ${puntaje}`, 20, yPos + 20);
                doc.text(`Categoría: ${categoria}`, 20, yPos + 30);

                // Guardar PDF como blob
                const pdfBlob = doc.output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);

                // Crear mensaje para WhatsApp
                const nombreEstablecimiento = getValue('establishmentName') || 'Establecimiento de Salud';
                const mensaje = `*Autoevaluación de ${nombreEstablecimiento}*\n\n` +
                    `Adjunto encontrará el reporte de autoevaluación realizado el ${new Date().toLocaleDateString()}.`;

                // Número de WhatsApp (595981574711)
                const telefonoWhatsApp = '595981574711';

                // Crear enlace de WhatsApp con el PDF
                // Nota: WhatsApp Web no permite enviar archivos directamente desde el navegador
                // Esta es una solución alternativa que muestra el PDF en una nueva pestaña
                // donde el usuario puede descargarlo y enviarlo manualmente

                // Primero mostramos el PDF para que el usuario pueda descargarlo
                const ventanaPDF = window.open(pdfUrl, '_blank');

                if (ventanaPDF) {
                    // Luego abrimos WhatsApp con el mensaje preparado
                    const urlWhatsApp = `https://wa.me/${telefonoWhatsApp}?text=${encodeURIComponent(mensaje)}`;
                    window.open(urlWhatsApp, '_blank');

                    mostrarNotificacion('PDF generado. Por favor adjunte el archivo manualmente en WhatsApp.');
                } else {
                    mostrarNotificacion('No se pudo abrir el PDF. Por favor intente nuevamente.', true);
                }

            } catch (error) {
                console.error("Error al generar PDF para WhatsApp:", error);
                mostrarNotificacion("Error al preparar el envío a WhatsApp", true);
            }
        }

        // Función para generar reporte con gráficos
        function generarReporte() {
            try {
                // Verificar si hay datos para mostrar
                if (Object.keys(servicios).length === 0) {
                    mostrarNotificacion("No hay datos para generar el reporte", true);
                    return;
                }

                // Crear modal para mostrar los gráficos
                const modalHTML = `
        <div class="modal fade" id="reporteModal" tabindex="-1" aria-labelledby="reporteModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="reporteModalLabel">Reporte Gráfico de Autoevaluación</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h5 class="text-center mb-3">Puntaje por Servicio</h5>
                                <canvas id="serviciosChart"></canvas>
                            </div>
                            <div class="col-md-6">
                                <h5 class="text-center mb-3">Distribución de Puntajes</h5>
                                <canvas id="distribucionChart"></canvas>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <h5 class="text-center mb-3">Progreso por Dimensión</h5>
                                <canvas id="dimensionesChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="button" class="btn btn-primary" onclick="exportarPDF()">
                            <i class="fas fa-file-pdf me-2"></i>Exportar a PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>`;

                // Agregar el modal al body (corregido)
                document.body.insertAdjacentHTML('beforeend', modalHTML);

                // Mostrar el modal
                const reporteModal = new bootstrap.Modal(document.getElementById('reporteModal'));
                reporteModal.show();

                // Resto del código permanece igual...
                // Preparar datos para los gráficos
                const serviciosLabels = Object.keys(servicios).map(key => {
                    // Mapear códigos a nombres más descriptivos
                    const nombresServicios = {
                        'a1': 'Consultorio Externo',
                        'a2': 'Atención Urgencias',
                        // Agrega más mapeos según tus servicios
                    };
                    return nombresServicios[key] || key.toUpperCase();
                });

                const serviciosData = Object.values(servicios);
                const puntajeTotal = document.getElementById('puntaje-total').textContent;
                const categoriaFinal = document.getElementById('categoria-final').textContent;

                // Colores para los gráficos
                const colores = [
                    'rgba(30, 90, 125, 0.8)',
                    'rgba(44, 138, 158, 0.8)',
                    'rgba(75, 181, 67, 0.8)',
                    'rgba(220, 53, 69, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(108, 117, 125, 0.8)',
                    'rgba(13, 110, 253, 0.8)'
                ];

                // Gráfico 1: Puntaje por Servicio (Barras)
                const serviciosCtx = document.getElementById('serviciosChart').getContext('2d');
                new Chart(serviciosCtx, {
                    type: 'bar',
                    data: {
                        labels: serviciosLabels,
                        datasets: [{
                            label: 'Puntaje',
                            data: serviciosData,
                            backgroundColor: colores.slice(0, serviciosLabels.length),
                            borderColor: colores.slice(0, serviciosLabels.length).map(c => c.replace('0.8', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 5,
                                title: {
                                    display: true,
                                    text: 'Puntaje (1-5)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return `Puntaje: ${context.raw}`;
                                    }
                                }
                            }
                        }
                    }
                });

                // Gráfico 2: Distribución de Puntajes (Dona)
                const distribucionCtx = document.getElementById('distribucionChart').getContext('2d');
                new Chart(distribucionCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Puntaje Total', 'Categoría'],
                        datasets: [{
                            data: [puntajeTotal, 100 - puntajeTotal], // Simulación para efecto visual
                            backgroundColor: ['rgba(75, 181, 67, 0.8)', 'rgba(240, 240, 240, 0.8)'],
                            borderColor: ['rgba(75, 181, 67, 1)', 'rgba(240, 240, 240, 1)'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        if (context.label === 'Puntaje Total') {
                                            return `Puntaje: ${puntajeTotal}`;
                                        } else {
                                            return `Categoría: ${categoriaFinal}`;
                                        }
                                    }
                                }
                            }
                        },
                        cutout: '70%'
                    }
                });

                // Gráfico 3: Progreso por Dimensión (Radar)
                // Este es un ejemplo - necesitarías recolectar datos por dimensión
                const dimensionesLabels = ['Recursos Humanos', 'Recursos Tecnológicos', 'Capacidad Resolutiva'];
                const dimensionesData = [
                    promedioPorDimension('Recursos Humanos'),
                    promedioPorDimension('Recursos Tecnológicos'),
                    promedioPorDimension('Capacidad Resolutiva')
                ];

                const dimensionesCtx = document.getElementById('dimensionesChart').getContext('2d');
                new Chart(dimensionesCtx, {
                    type: 'radar',
                    data: {
                        labels: dimensionesLabels,
                        datasets: [{
                            label: 'Puntaje Promedio',
                            data: dimensionesData,
                            backgroundColor: 'rgba(30, 90, 125, 0.2)',
                            borderColor: 'rgba(30, 90, 125, 1)',
                            pointBackgroundColor: 'rgba(30, 90, 125, 1)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(30, 90, 125, 1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            r: {
                                angleLines: {
                                    display: true
                                },
                                suggestedMin: 0,
                                suggestedMax: 5
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });

                // Función auxiliar para calcular promedio por dimensión
                function promedioPorDimension(dimension) {
                    let total = 0;
                    let count = 0;

                    document.querySelectorAll('.service-table tbody tr').forEach(row => {
                        const cells = row.cells;
                        if (cells[0].textContent.trim() === dimension) {
                            const select = cells[1].querySelector('select');
                            if (select && select.value) {
                                total += parseInt(select.value);
                                count++;
                            }
                        }
                    });

                    return count > 0 ? (total / count).toFixed(2) : 0;
                }

                // Eliminar el modal cuando se cierre
                document.getElementById('reporteModal').addEventListener('hidden.bs.modal', function () {
                    this.remove();
                });

                mostrarNotificacion("Reporte generado con gráficos interactivos");

            } catch (error) {
                console.error("Error al generar reporte:", error);
                mostrarNotificacion("Error al generar el reporte", true);
            }
        }

        // Exportar a PDF
        function exportarPDF() {
            try {
                // Verificar si hay datos para exportar
                if (Object.keys(servicios).length === 0) {
                    mostrarNotificacion("No hay datos para generar el PDF", true);
                    return;
                }

                mostrarNotificacion("Generando PDF...");

                // Crear nuevo documento PDF
                const doc = new jsPDF();

                // Configuración inicial
                doc.setFont('helvetica');
                doc.setFontSize(16);
                doc.setTextColor(30, 90, 125);
                doc.text('Reporte de Autoevaluación', 105, 20, { align: 'center' });

                // Datos del establecimiento
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);

                const getValue = (id) => {
                    const element = document.getElementById(id);
                    return element ? (element.value || 'No especificado') : 'No disponible';
                };

                doc.text(`Nombre del Establecimiento: ${getValue('establishmentName')}`, 20, 40);
                doc.text(`Ubicación: ${getValue('department')}`, 20, 50);
                doc.text(`ID: ${getValue('establishmentID')}`, 20, 60);

                // Resultados por servicio
                doc.setFontSize(14);
                doc.setTextColor(30, 90, 125);
                doc.text('Resultados por Servicio', 20, 80);

                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);

                let yPos = 90;
                for (const id in servicios) {
                    if (servicios.hasOwnProperty(id)) {
                        doc.text(`${id.toUpperCase()}: ${servicios[id]}`, 20, yPos);
                        yPos += 10;

                        // Agregar nueva página si nos quedamos sin espacio
                        if (yPos > 280) {
                            doc.addPage();
                            yPos = 20;
                        }
                    }
                }

                // Resultado global
                doc.setFontSize(14);
                doc.setTextColor(30, 90, 125);
                doc.text('Resultado Global', 20, yPos + 10);

                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);

                const puntajeElement = document.getElementById('puntaje-total');
                const categoriaElement = document.getElementById('categoria-final');
                const puntaje = puntajeElement ? puntajeElement.textContent : '-';
                const categoria = categoriaElement ? categoriaElement.textContent : 'No categorizado';

                doc.text(`Puntaje total: ${puntaje}`, 20, yPos + 20);
                doc.text(`Categoría: ${categoria}`, 20, yPos + 30);

                // Fecha de generación
                doc.setFontSize(10);
                doc.text(`Generado el ${new Date().toLocaleString()}`, 20, yPos + 40);

                // Guardar el PDF
                doc.save('autoevaluacion_ips.pdf');
                mostrarNotificacion("PDF generado con éxito");

            } catch (error) {
                console.error("Error al exportar a PDF:", error);
                mostrarNotificacion("Error al exportar a PDF", true);
            }
        }

        // Exportar a SQLite (simulación)
        function exportarSQLite() {
            mostrarNotificacion("Función de exportar a SQLite - Requiere implementación completa");
        }

        // Resetear formulario con SweetAlert
        function resetearFormulario() {
            Swal.fire({
                title: '¿Está seguro?',
                text: "Esta acción reseteará todo el formulario y no se puede deshacer.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#1e5a7d',
                cancelButtonColor: '#dc3545',
                confirmButtonText: 'Sí, resetear',
                cancelButtonText: 'Cancelar',
                backdrop: `
            rgba(30, 90, 125, 0.4)
            url("https://sweetalert2.github.io/images/nyan-cat.gif")
            center top
            no-repeat
        `
            }).then((result) => {
                if (result.isConfirmed) {
                    try {
                        // Limpiar campos
                        document.querySelectorAll('input, select').forEach(elemento => {
                            elemento.value = '';
                            elemento.classList.remove('is-invalid');
                            if (elemento.id) {
                                localStorage.removeItem(elemento.id);
                            }
                        });

                        // Limpiar promedios
                        document.querySelectorAll('[id^="promedio-"]').forEach(elemento => {
                            elemento.textContent = '-';
                        });

                        // Limpiar resultados globales
                        const puntajeElement = document.getElementById('puntaje-total');
                        const categoriaElement = document.getElementById('categoria-final');

                        if (puntajeElement) puntajeElement.textContent = '-';
                        if (categoriaElement) categoriaElement.textContent = '-';

                        // Limpiar objeto de servicios
                        for (const key in servicios) {
                            if (servicios.hasOwnProperty(key)) {
                                delete servicios[key];
                            }
                        }

                        // Resetear progreso
                        actualizarProgreso();

                        // Mostrar confirmación con SweetAlert
                        Swal.fire({
                            title: '¡Reseteado!',
                            text: 'El formulario ha sido reseteado correctamente.',
                            icon: 'success',
                            confirmButtonColor: '#1e5a7d',
                            timer: 2000,
                            timerProgressBar: true
                        });
                    } catch (error) {
                        console.error("Error al resetear formulario:", error);
                        Swal.fire({
                            title: 'Error',
                            text: 'Ocurrió un error al resetear el formulario',
                            icon: 'error',
                            confirmButtonColor: '#dc3545'
                        });
                    }
                }
            });
        }
        // Cargar datos guardados
        function cargarDatosGuardados() {
            try {
                let contadorCargados = 0;
                document.querySelectorAll('input, select').forEach(elemento => {
                    if (elemento.id) {
                        const valor = localStorage.getItem(elemento.id);
                        if (valor !== null) {
                            elemento.value = valor;
                            contadorCargados++;

                            // Disparar evento change para selects con valor
                            if (elemento.tagName === 'SELECT' && elemento.classList.contains('servicio')) {
                                const evento = new Event('change');
                                elemento.dispatchEvent(evento);
                            }
                        }
                    }
                });

                if (contadorCargados > 0) {
                    mostrarNotificacion(`Se han cargado ${contadorCargados} valores guardados`);
                }
            } catch (error) {
                console.error("Error al cargar datos guardados:", error);
                mostrarNotificacion("Error al cargar datos guardados", true);
            }
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            configurarEventosServicios();
            cargarDatosGuardados();
            actualizarProgreso();

            // Configurar tooltips de Bootstrap
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Autoguardar cada 5 minutos
            setInterval(guardarTemporal, 300000);
        });
    </script>
</body>

</html>